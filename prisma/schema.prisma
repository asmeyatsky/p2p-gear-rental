// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                String    @id @unique
  email             String    @unique
  full_name         String?
  bio               String?
  profileImageUrl   String?
  phoneNumber       String?
  phoneVerified     Boolean   @default(false)

  // Trust & Verification
  verificationStatus VerificationStatus @default(UNVERIFIED)
  identityVerifiedAt DateTime?
  governmentIdUrl   String?           // Stored securely, reference to verification service
  trustScore        Float?            // 0-100 calculated score

  // Location
  city              String?
  state             String?

  // Stripe Connect for payouts
  stripeAccountId   String?           // Stripe Connect account for receiving payments
  stripeAccountStatus String?         // onboarding status

  gears             Gear[]
  rentedItems       Rental[]  @relation("RenterRentals")
  ownedRentals      Rental[]  @relation("OwnerRentals")
  reviewsGiven      Review[]  @relation("ReviewsGiven")
  reviewsReceived   Review[]  @relation("ReviewsReceived")
  messagesSent      Message[] @relation("MessagesSent")
  disputesReported  Dispute[] @relation("DisputesReported")
  disputesAgainst   Dispute[] @relation("DisputesAgainst")
  disputeResponses  DisputeResponse[] @relation("DisputeResponses")
  averageRating     Float?
  totalReviews      Int       @default(0)
  completedRentals  Int       @default(0)   // Track successful rentals
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([email])
  @@index([createdAt])
  @@index([averageRating])
  @@index([verificationStatus])
  @@index([trustScore])
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

model Gear {
  id          String    @id @default(cuid())
  title       String
  description String
  dailyRate   Float
  weeklyRate  Float?
  monthlyRate Float?
  images      String[]
  city        String
  state       String
  category    String?
  brand       String?
  model       String?
  condition   String?

  // Insurance & Protection
  replacementValue  Float?            // Full replacement cost if damaged/lost
  insuranceRequired Boolean @default(false)  // Owner can require renters to have insurance
  securityDeposit   Float?            // Optional security deposit amount

  // Availability
  isAvailable       Boolean @default(true)   // Quick toggle for owners to pause listings

  userId      String?
  user        User?     @relation(fields: [userId], references: [id])
  rentals     Rental[]
  damageClaims DamageClaim[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  averageRating     Float?
  totalReviews      Int       @default(0)
  totalRentals      Int       @default(0)

  @@index([category])
  @@index([city, state])
  @@index([dailyRate])
  @@index([userId])
  @@index([createdAt])
  @@index([condition])
  @@index([brand])
  @@index([model])
  @@index([brand, model])
  @@index([weeklyRate])
  @@index([monthlyRate])
  @@index([averageRating])
  @@index([isAvailable])
}

model Rental {
  id           String        @id @default(cuid())
  gearId       String
  gear         Gear          @relation(fields: [gearId], references: [id])
  renterId     String
  renter       User          @relation("RenterRentals", fields: [renterId], references: [id])
  ownerId      String
  owner        User          @relation("OwnerRentals", fields: [ownerId], references: [id])
  startDate    DateTime
  endDate      DateTime
  status       RentalStatus  @default(PENDING)
  message      String?

  // Payment
  totalPrice        Float?
  paymentIntentId   String?
  clientSecret      String?
  paymentStatus     String?

  // Insurance & Protection
  insuranceType     InsuranceType @default(NONE)
  insurancePremium  Float?        // Cost of insurance
  securityDepositPaid Float?      // Amount held as deposit
  securityDepositRefunded Boolean @default(false)

  // Condition tracking
  preRentalCondition  String?     // Notes/checklist before rental
  postRentalCondition String?     // Notes/checklist after rental
  preRentalPhotos     String[]    // Photo URLs documenting condition before
  postRentalPhotos    String[]    // Photo URLs documenting condition after

  // Timestamps
  approvedAt    DateTime?
  pickedUpAt    DateTime?         // When renter picked up gear
  returnedAt    DateTime?         // When renter returned gear
  completedAt   DateTime?

  review       Review?
  conversation Conversation?
  dispute      Dispute?
  damageClaim  DamageClaim?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([renterId])
  @@index([ownerId])
  @@index([gearId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([paymentStatus])
  @@index([createdAt])
}

enum RentalStatus {
  PENDING           // Request submitted, awaiting owner approval
  APPROVED          // Owner approved, awaiting payment
  PAYMENT_PENDING   // Payment initiated
  CONFIRMED         // Payment received, rental confirmed
  ACTIVE            // Rental in progress (gear picked up)
  RETURNED          // Gear returned, awaiting condition check
  COMPLETED         // Successfully completed
  CANCELLED         // Cancelled by renter or owner
  REJECTED          // Owner rejected the request
  DISPUTED          // Under dispute
}

enum InsuranceType {
  NONE              // No insurance
  BASIC             // Covers up to $500 damage
  STANDARD          // Covers up to $2000 damage
  PREMIUM           // Full replacement coverage
}

model DamageClaim {
  id          String   @id @default(cuid())
  rentalId    String   @unique
  rental      Rental   @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  gearId      String
  gear        Gear     @relation(fields: [gearId], references: [id])

  claimType   DamageClaimType
  description String
  amount      Float             // Claimed amount
  approvedAmount Float?         // Final approved amount
  photoUrls   String[]          // Evidence photos
  status      DamageClaimStatus @default(PENDING)

  // Resolution
  resolution     String?
  resolvedAt     DateTime?
  insurancePaid  Float?        // Amount covered by insurance
  renterPaid     Float?        // Amount charged to renter

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([gearId])
  @@index([createdAt])
}

enum DamageClaimType {
  MINOR_DAMAGE      // Scratches, scuffs
  MAJOR_DAMAGE      // Significant damage affecting function
  LOST_ITEM         // Equipment not returned
  MISSING_ACCESSORY // Missing parts/accessories
  THEFT             // Suspected theft
}

enum DamageClaimStatus {
  PENDING           // Claim submitted
  UNDER_REVIEW      // Being reviewed
  APPROVED          // Claim approved
  PARTIALLY_APPROVED // Partial amount approved
  REJECTED          // Claim rejected
  PAID              // Payment processed
}

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5 stars
  comment   String?
  rentalId  String   @unique
  rental    Rental   @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  reviewerId String
  reviewer  User     @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  revieweeId String  // The person being reviewed (gear owner)
  reviewee  User     @relation("ReviewsReceived", fields: [revieweeId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([revieweeId])
  @@index([rating])
  @@index([createdAt])
}

model Conversation {
  id          String    @id @default(cuid())
  rentalId    String    @unique
  rental      Rental    @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  messages    Message[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([rentalId])
  @@index([updatedAt])
}

model Message {
  id             String       @id @default(cuid())
  content        String
  senderId       String
  sender         User         @relation("MessagesSent", fields: [senderId], references: [id])
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt])
  @@index([senderId])
}

model Dispute {
  id          String   @id @default(cuid())
  rentalId    String   @unique
  rental      Rental   @relation(fields: [rentalId], references: [id], onDelete: Cascade)
  reporterId  String   // User who reported the dispute
  reporter    User     @relation("DisputesReported", fields: [reporterId], references: [id])
  respondentId String  // User being disputed against
  respondent  User     @relation("DisputesAgainst", fields: [respondentId], references: [id])
  category    DisputeCategory
  subject     String
  description String
  status      DisputeStatus @default(OPEN)
  priority    DisputePriority @default(MEDIUM)
  evidence    String[] // Array of URLs to uploaded evidence files
  resolution  String? // Admin's final resolution
  adminNotes  String? // Internal admin notes
  resolvedAt  DateTime?
  resolvedBy  String? // Admin user ID who resolved it
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  responses   DisputeResponse[]

  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([reporterId])
  @@index([respondentId])
  @@index([createdAt])
}

model DisputeResponse {
  id        String   @id @default(cuid())
  disputeId String
  dispute   Dispute  @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("DisputeResponses", fields: [userId], references: [id])
  message   String
  isAdmin   Boolean  @default(false)
  evidence  String[] // Array of URLs to uploaded evidence files
  createdAt DateTime @default(now())

  @@index([disputeId, createdAt])
  @@index([userId])
}

enum DisputeCategory {
  DAMAGE
  MISSING_ITEM
  PAYMENT_ISSUE
  COMMUNICATION
  POLICY_VIOLATION
  SAFETY_CONCERN
  OTHER
}

enum DisputeStatus {
  OPEN
  IN_REVIEW
  AWAITING_RESPONSE
  RESOLVED
  CLOSED
  ESCALATED
}

enum DisputePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}