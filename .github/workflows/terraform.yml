name: Terraform Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - stage
          - prod
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  TF_VERSION: '1.5.7'
  GCP_PROJECT_ID: 'p2pgear'
  GCP_REGION: 'europe-west2'

jobs:
  # Plan job runs on PRs and manual triggers
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')

    strategy:
      matrix:
        environment: ${{ github.event_name == 'workflow_dispatch' && fromJSON(format('["{0}"]', github.event.inputs.environment)) || fromJSON('["stage", "prod"]') }}

    permissions:
      contents: read
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init (${{ matrix.environment }})
        working-directory: terraform
        run: |
          terraform init \
            -backend-config=backends/${{ matrix.environment }}.backend.hcl

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: Terraform Plan (${{ matrix.environment }})
        id: plan
        working-directory: terraform
        run: |
          terraform plan \
            -var-file=environments/${{ matrix.environment }}.tfvars \
            -var="project_id=${{ env.GCP_PROJECT_ID }}" \
            -var="next_public_base_url=${{ matrix.environment == 'prod' && secrets.PROD_BASE_URL || secrets.STAGE_BASE_URL }}" \
            -var="next_public_supabase_url=${{ secrets.SUPABASE_URL }}" \
            -var="next_public_supabase_anon_key=${{ secrets.SUPABASE_ANON_KEY }}" \
            -var="supabase_service_role_key=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -var="stripe_secret_key=${{ matrix.environment == 'prod' && secrets.STRIPE_SECRET_KEY_PROD || secrets.STRIPE_SECRET_KEY_TEST }}" \
            -var="stripe_webhook_secret=${{ matrix.environment == 'prod' && secrets.STRIPE_WEBHOOK_SECRET_PROD || secrets.STRIPE_WEBHOOK_SECRET_TEST }}" \
            -var="external_database_url=${{ matrix.environment == 'stage' && secrets.SUPABASE_DATABASE_URL || '' }}" \
            -no-color \
            -out=tfplan-${{ matrix.environment }}
        continue-on-error: true

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Plan - ${{ matrix.environment }} üèóÔ∏è

            \`\`\`
            ${{ steps.plan.outputs.stdout }}
            \`\`\`

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.environment }}
          path: terraform/tfplan-${{ matrix.environment }}
          retention-days: 5

  # Apply job runs on pushes to main (staging only) or manual triggers
  terraform-apply-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply' && github.event.inputs.environment == 'stage')
    environment: staging

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init (staging)
        working-directory: terraform
        run: |
          terraform init \
            -backend-config=backends/stage.backend.hcl

      - name: Terraform Apply (staging)
        working-directory: terraform
        run: |
          terraform apply \
            -var-file=environments/stage.tfvars \
            -var="project_id=${{ env.GCP_PROJECT_ID }}" \
            -var="next_public_base_url=${{ secrets.STAGE_BASE_URL }}" \
            -var="next_public_supabase_url=${{ secrets.SUPABASE_URL }}" \
            -var="next_public_supabase_anon_key=${{ secrets.SUPABASE_ANON_KEY }}" \
            -var="supabase_service_role_key=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -var="stripe_secret_key=${{ secrets.STRIPE_SECRET_KEY_TEST }}" \
            -var="stripe_webhook_secret=${{ secrets.STRIPE_WEBHOOK_SECRET_TEST }}" \
            -var="external_database_url=${{ secrets.SUPABASE_DATABASE_URL }}" \
            -auto-approve

  # Production deploy requires manual trigger
  terraform-apply-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply' && github.event.inputs.environment == 'prod'
    environment: production

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init (production)
        working-directory: terraform
        run: |
          terraform init \
            -backend-config=backends/prod.backend.hcl

      - name: Terraform Apply (production)
        working-directory: terraform
        run: |
          terraform apply \
            -var-file=environments/prod.tfvars \
            -var="project_id=${{ env.GCP_PROJECT_ID }}" \
            -var="next_public_base_url=${{ secrets.PROD_BASE_URL }}" \
            -var="next_public_supabase_url=${{ secrets.SUPABASE_URL }}" \
            -var="next_public_supabase_anon_key=${{ secrets.SUPABASE_ANON_KEY }}" \
            -var="supabase_service_role_key=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -var="stripe_secret_key=${{ secrets.STRIPE_SECRET_KEY_PROD }}" \
            -var="stripe_webhook_secret=${{ secrets.STRIPE_WEBHOOK_SECRET_PROD }}" \
            -auto-approve

  # Destroy job (manual only, requires explicit confirmation)
  terraform-destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    environment: ${{ github.event.inputs.environment }}-destroy

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config=backends/${{ github.event.inputs.environment }}.backend.hcl

      - name: Terraform Destroy
        working-directory: terraform
        run: |
          terraform destroy \
            -var-file=environments/${{ github.event.inputs.environment }}.tfvars \
            -var="project_id=${{ env.GCP_PROJECT_ID }}" \
            -var="next_public_base_url=${{ github.event.inputs.environment == 'prod' && secrets.PROD_BASE_URL || secrets.STAGE_BASE_URL }}" \
            -var="next_public_supabase_url=${{ secrets.SUPABASE_URL }}" \
            -var="next_public_supabase_anon_key=${{ secrets.SUPABASE_ANON_KEY }}" \
            -var="supabase_service_role_key=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -var="stripe_secret_key=${{ github.event.inputs.environment == 'prod' && secrets.STRIPE_SECRET_KEY_PROD || secrets.STRIPE_SECRET_KEY_TEST }}" \
            -var="stripe_webhook_secret=${{ github.event.inputs.environment == 'prod' && secrets.STRIPE_WEBHOOK_SECRET_PROD || secrets.STRIPE_WEBHOOK_SECRET_TEST }}" \
            -var="external_database_url=${{ github.event.inputs.environment == 'stage' && secrets.SUPABASE_DATABASE_URL || '' }}" \
            -auto-approve
